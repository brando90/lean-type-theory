\section{Properties of the type system}
A theorem we would like to have of Lean's type system is that it is consistent, and sound with respect to some semantics in a well understood axiom system such as ZFC. Moreover, we want to relate this to Lean's actual typechecker, in the sense that anything Lean verifies as type-correct will be derivable in this axiom system and hence Lean will not certify a contradiction. But first we must understand some aspects of the type system itself, before relating it to other systems.

It is important to note that \emph{Lean's typechecker is not complete.} Obviously Lean can fail on correct theorems due to, say, running out of resources, but the ``algorithmic equality'' relation does not validate all definitional equalities. In fact, we can show that definitional equality as defined here is undecidable.

\subsection{Undecidability of definitional equality}\label{sec:undecidable}
Recall the type $\acc$ from section \ref{sec:large_elim}:
$$\acc_{<}:=\mu A:\alpha\to\P.\ (\intro:\forall x:\alpha.\;(\forall y:\alpha.\;y<x\to A\;y)\to A\;x)$$
(We are fixing a type $\alpha$ and a relation ${<}:\alpha\to\alpha\to\P$ here.) Informally, we would read this as: ``$x$ is $<$-accessible if for all $y<x$, $y$ is $<$-accessible''. Accessibility is then inductively generated by this clause. If every $x:\alpha$ is accessible, then $<$ is a well-founded relation. One interesting fact about $\acc$ is that we can project out the argument given a proof of $\acc\;x$:
\begin{align*}
\inv_x&:\acc\;x\to\forall y:\alpha.\;y<x\to\acc\;y\\
\inv_x&:=\lambda a:\acc\;x.\;\lambda y:\alpha.\;\rec_{\acc}\;(\lambda z.\;y<z\to\acc\;y)\\
&(\lambda z.\;\lambda h:(\forall w.\;w<z\to\acc\;w).\;\lambda \_.\;h\;y)\;x\;a
\end{align*}
Note that the output type of $\inv_x$ is the same as the argument to $\intro\;x$. Thus, we have
$$a\equiv\intro_\acc\;x\;(\inv_x\;a)$$
by proof irrelevance.

Why does this matter? Normally, any proof of $\acc\;x$ could only be unfolded finitely many times by the very nature of inductive proofs, but if we are in an inconsistent context, it is possible to get a proof of wellfoundedness which isn't actually wellfounded, and we can end up unfolding it forever.

To show how to get undecidability from this, suppose $P:\N\to\bf 2$ is a decidable predicate, such as $P\;n:=\;$``Turing machine $M$ runs for at least $n$ steps without halting''. It is not difficult to show that $P\;n$ is decidable but $\forall n.\;P\;n$ is not. Let $>$ be the standard greater-than function on $\N$ (which is not well-founded). We define a function $f:\forall n.\;\acc_{>}\;n\to\bf 1$ as follows:
\begin{align*}
f&:=\rec_{\acc}\;(\lambda\_.\;{\bf 1})\;(\lambda n\;\_\;(g:\forall y.\;y>x\to{\bf 1}).\\
&\qquad\mathsf{if}\;P\;n\;\mathsf{then}\;g\;(n+1)\;(p\;n)\;\mathsf{else}\;()
\end{align*}
where $p\;n$ is a proof of $n<n+1$. Of course this whole function is trivial since the precondition $\acc_{>}n$ is impossible, but definitional equality works in all contexts, including inconsistent ones. This function evaluates as:
$$f\;n\;(\intro_\acc\;n\;h)\rightsquigarrow^*\mathsf{if}\;P\;n\;\mathsf{then}\;f\;(n+1)\;(h\;(n+1)\;(p\;n))\;\mathsf{else}\;()$$
and the \textsf{if} statement evaluates to the left or right branch depending on whether $P\;n\rightsquigarrow^*\mathsf{tt}$ or $P\;n\rightsquigarrow^*\mathsf{ff}$. Now, this is all true of the reduction relation $\rightsquigarrow$, but if we bring in the full power of definitional equivalence we have the ability to work up from a single proof $a:\acc_{>}\;0$:
\begin{align*}
f\;0\;a&\equiv f\;0\;(\intro_\acc\;0\;(\inv_0\;a))\\
&\equiv f\;1\;(\inv_0\;a\;1\;(p\;0))\\
&\equiv f\;1\;(\intro_\acc\;1\;(\inv_1\;(\inv_0\;a\;1\;(p\;0)))\\
&\equiv f\;2\;(\inv_1\;(\inv_0\;a\;1\;(p\;0))\;2\;(p\;1))\\
&\equiv\dots
\end{align*}
where we have shown the case where $P\;0$ and $P\;1$ both evaluate to true. If any $P\;n$ evaluates to false, then we will eventually get an equivalence to $()$, but if $P\;n$ is always true, then $f$ will never reduce to $()$ -- every term definitionally equal to $f\;0\;a$ will contain a subterm def.eq. to $f$. So $a:\acc_{>}\;0\vdash f\;0\;a\equiv()$ holds if and only if $\forall n.\;P\;n$, and hence $\equiv$ is undecidable.

\subsubsection{Algorithmic equality is not transitive}
From the results of the previous section, given that algorithmic equality is implemented by Lean, and hence is obviously decidable, they cannot be equal as relations, so there is some rule of definitional equality that is not respected by algorithmic equality. In the above example, we can typecheck the various parts of the equality chain to see that $\Leftrightarrow$ is not transitive:
\begin{align*}
f\;0\;a&\Leftrightarrow f\;0\;(\intro_\acc\;0\;(\inv_0\;a))\\
&\Leftrightarrow f\;1\;(\inv_0\;a\;1\;(p\;0))\\
&\mbox{but}\\
f\;0\;a&\not\Leftrightarrow f\;1\;(\inv_0\;a\;1\;(p\;0)).
\end{align*}
We can think of the middle step $f\;0\;(\intro_\acc\;0\;(\inv_0\;a))$ as a ``creative'' step, where we pick one of the many possible terms of type $\acc_{>}\;0$ which happens to reduce in the right way. But since the expression $f\;0\;a$ is a normal form, we don't attempt to reduce it, and indeed if we did we would have nontermination problems (since reduction here only makes the term larger).

Note that the fact that we are in an inconsistent context doesn't matter for this: we could have used $a:\acc_{<}\;1$ with the same result.

This instance of non-transitivity can be traced back to the usage of a K-like eliminator via $\acc$. There is another, less known source of non-transitivity: quotients of propositions. While this is not a particularly useful operation, since any proposition is already a subsingleton, so a quotient will not do anything, they can technically be formed, and $\lift$ acts like a K-like eliminator in this case. So for example, if $p:\P$, $R:p\to p\to\P$, $\alpha:\U_1$, $f:p\to\alpha$, $H:\forall x\;y.\;r\;x\;y\to f\;x= f\;y$, $q:p/R$ and $h:p$, then:
\begin{align*}
\lift_R\;\alpha\;f\;H\;q&\Leftrightarrow \lift_R\;\alpha\;f\;H\;(\mk_R\;h)\Leftrightarrow f\;h\\
&\mbox{but}\\
\lift_R\;\alpha\;f\;H\;q&\not\Leftrightarrow f\;h.
\end{align*}

\subsubsection{Failure of subject reduction}
While the type system given here actually satisfies subject reduction (which is to say, if $\Gamma\vdash e:\alpha$ and $e\rightsquigarrow e'$ (or $\Gamma\vdash e\Leftrightarrow e'$, or $\Gamma\vdash e\equiv e'$), then $\Gamma\vdash e':\alpha$), this is because we use the $\equiv$ relation in the conversion rule $\Gamma\vdash e:\alpha$, $\Gamma\vdash \alpha\equiv\beta$ implies $\Gamma\vdash e:\beta$. If we used algorithmic equality instead, to get a variant typing judgment $\Gamma\Vdash e:\alpha$ closer to what one would expect of the Lean typechecker, we find failure of subject reduction, directly from failure of transitivity. If $\Gamma\vdash\alpha\Leftrightarrow\beta$, $\Gamma\vdash\beta\Leftrightarrow\gamma$, $\Gamma\vdash\alpha\not\Leftrightarrow\gamma$, and $\Gamma\Vdash e:\gamma$, then:
\begin{itemize}
\item $\Gamma\Vdash \mbox{id}_\beta\;e:\beta$ because the application forces checking $\Gamma\vdash\beta\Leftrightarrow\gamma$.
\item $\Gamma\Vdash \mbox{id}_\alpha\;(\mbox{id}_\beta\;e):\alpha$ since the application forces checking $\Gamma\vdash\alpha\Leftrightarrow\beta$.
\item But $\Gamma\not\Vdash \mbox{id}_\alpha\;e:\alpha$ because this requires $\Gamma\vdash\alpha\Leftrightarrow\gamma$ which is false.
\end{itemize}
Since we obviously have $\mbox{id}_\beta\;e\rightsquigarrow e$ by the $\beta$ and $\delta$ rules, this is a counterexample to subject reduction.
\subsection{Regularity}
These lemmas are essentially trivial inductions and are true by virtue of the way we set up the type system, so they are recorded here simply to keep track of the invariants.

\begin{lemma}[Regularity]\label{thm:reg}
\begin{enumerate}
\item If $\Gamma\vdash e:\alpha$, then $\vdash\Gamma\;\mathsf{ok}$.
\item If $\Gamma\vdash e:\alpha$, then $FV(e)\cup FV(\alpha)\subseteq\Gamma$.
\item If $\Gamma\vdash\alpha\type$, then $\Gamma\vdash\alpha:\U_\ell$ for some $\ell$.
\item If $\Gamma\vdash e:\alpha$, then $\Gamma\vdash\alpha\type$.
\item\label{item:defeq_reg2} If $\Gamma\vdash e\equiv e'$, then there exists $\alpha,\alpha'$ such that $\Gamma\vdash e:\alpha$ and $\Gamma\vdash e':\alpha'$.
\item If $\Gamma\vdash e:\alpha$ and $e\rightsquigarrow e'$, then $\Gamma\vdash e\equiv e'$.
\item If $\Gamma\vdash e:\alpha$ and $e\downarrow k$, then $\Gamma\vdash e\equiv k$.
\item\label{item:alg_defn} If $\Gamma\vdash e:\alpha$ and $\Gamma\vdash e':\alpha$, and $\Gamma\vdash e\Leftrightarrow e'$, then $\Gamma\vdash e\equiv e'$.
\item If $\Gamma;t:F\vdash K\spec$, then $\Gamma\vdash F\type$ (and more precisely, $F=\forall x::\alpha.\;\U_\ell$ for some $\alpha,\ell$).
\item If $\Gamma;t:F\vdash K\spec$ and $(c:\alpha)\in K$, then $\Gamma;t:F\vdash\alpha\ctor$.
\item If $\Gamma;t:F\vdash \alpha\ctor$, then $\Gamma,t:F\vdash\alpha\type$.
\end{enumerate}
\end{lemma}
\begin{proof}
By induction on the respective judgments (all of the parts may be proven separately).
\end{proof}

\begin{lemma}[Weakening]\label{thm:weak}
\begin{enumerate}
\item If $\Gamma\vdash e:\alpha$ and $\vdash\Gamma,\Delta\ok$, then $\Gamma,\Delta\vdash e:\alpha$.
\item If $\Gamma\vdash e\equiv e'$ and $\vdash\Gamma,\Delta\ok$, then $\Gamma,\Delta\vdash e\equiv e'$.
\item If $\Gamma,\Delta\vdash e:\alpha$ and $FV(e)\subseteq\Gamma$, then $\Gamma\vdash e:\alpha$.
\item If $\Gamma,\Delta\vdash e\equiv e'$ and $FV(e)\cup FV(e')\subseteq\Gamma$, then $\Gamma\vdash e\equiv e'$.
\item $\Gamma\vdash e:\alpha$ implies $\Gamma\vdash' e:\alpha$, and $\Gamma\vdash e\equiv e'$ implies $\Gamma\vdash' e\equiv e'$, where the modified judgment $\vdash'$ eliminates the weakening rules and replaces the variable and universe rules with
$$\frac{(x:\alpha)\in\Gamma}{\Gamma\vdash x:\alpha}\qquad\frac{}{\Gamma\vdash \U_\ell:\U_{S\ell}}\qquad\frac{\ell\equiv\ell'}{\Gamma\vdash \U_\ell\equiv\U_{\ell'}}$$
\end{enumerate}
\end{lemma}
\begin{proof}
(1,2) and (3,4) are each proven by mutual induction on the first hypothesis. For (5), since weakening is provable for the judgment $\vdash'$ it follows that all rules of $\vdash$ are provable in $\vdash'$.
\end{proof}

\begin{lemma}[Properties of substitution]\label{thm:subst}
\begin{enumerate}
\item If $\Gamma,x:\alpha\vdash e_1\equiv e_1'$ and $\Gamma\vdash e_2:\alpha$, then $\Gamma\vdash e_1[e_2/x]\equiv e_1'[e_2/x]$.
\item\label{item:subst_ty} If $\Gamma,x:\alpha\vdash e_1:\beta$ and $\Gamma\vdash e_2:\alpha$, then $\Gamma\vdash e_1[e_2/x]:\beta[e_2/x]$.
\item If $\Gamma,x:\alpha\vdash e_1:\beta$ and $\Gamma\vdash e_2\equiv e_2':\alpha$, then $\Gamma\vdash e_1[e_2/x]\equiv e_1[e_2'/x]$.
\end{enumerate}
\end{lemma}
\begin{proof} (1) and (2) must be proven simultaneously by induction on the first hypotheses. All cases are straightforward. In the proof irrelevance case, we know $\Gamma,x:\alpha\vdash e_1:p$ and $\Gamma,x:\alpha\vdash e_1':p$ for some $p$ with $\Gamma,x:\alpha\vdash p:\P$. By the induction hypothesis, $\Gamma\vdash e_1[e_2/x]:p[e_2/x]$ and $\Gamma\vdash e_1'[e_2/x]:p[e_2/x]$ and $\Gamma\vdash p[e_2/x]:\P[e_2/x]$; but $\P[e_2/x]=\P$ so proof irrelevance applies to show $\Gamma\vdash e_1[e_2/x]=e_1'[e_2/x]$.

(3) is proven by induction on the structure of $e_1$ and applying compatibility lemmas in each case.
\end{proof}

With this theorem we can upgrade lemma \ref{thm:reg}(\ref{item:defeq_reg2}) to:
\begin{lemma}[Regularity continued]
\begin{enumerate}
\item If $\Gamma\vdash e\equiv e'$, then there exists $\alpha$ such that $\Gamma\vdash e\equiv e':\alpha$.
\end{enumerate}
\end{lemma}
\begin{proof}
Straightforward induction on the derivation of $\Gamma\vdash e\equiv e'$. We need lemma \ref{thm:subst}(\ref{item:subst_ty}) to typecheck both sides of the $\beta$ rule. Note that the induction hypothesis is not strong enough for the application rule, except that we explicitly require that both sides have agreeing types in this case.
\end{proof}

\subsection{Minimal derivations}
Let the notation $\Gamma\vdash_0e:\alpha$ mean that $\Gamma\vdash e:\alpha$, and there is no derivation of  $\Gamma\vdash' e:\alpha'$ that has fewer steps than some derivation of $\Gamma\vdash' e:\alpha$ (where the number of steps of a derivation is the sum of the number of steps of the hypotheses to the rule plus one), where the $\vdash'$ derivation is the weakening-free judgment defined in lemma \ref{thm:weak}. (Alternatively, we could count steps in a $\vdash$ derivation but ignore weakening steps.) The step counting does not include embedded derivations of $\Gamma\vdash e\equiv e'$, it only counts the typing steps.

\begin{lemma}[Properties of $\vdash_0$]
\begin{enumerate}
\item If $\Gamma\vdash e:\beta$, then $\Gamma\vdash_0e:\alpha$ for some $\alpha$.
\item The final rule in a derivation of $\Gamma\vdash_0e:\alpha$ cannot be the conversion rule.
\item If $\Gamma\vdash e:\alpha$, then either $\Gamma\vdash_0 e:\alpha$, or there is a minimal derivation whose last step is a conversion $\Gamma\vdash\beta\equiv\alpha$ where $\Gamma\vdash_0e:\beta$.
\item If $\Gamma,\Delta\vdash_0e:\alpha$ and $FV(e)\subseteq\Gamma$, then $\Gamma\vdash_0e:\alpha$.
\item If $\Gamma\vdash_0x:\alpha$, then $(x:\alpha)\in\Gamma$.
\item If $\Gamma\vdash_0\U_\ell:\alpha$, then $\alpha=\U_{S\ell}$.
\item If $\Gamma\vdash_0 e_1\;e_2:\gamma$, then $\gamma=\beta[e_2/x]$, $\Gamma\vdash e_1:\forall x:\alpha.\;\beta$, and $\Gamma\vdash e_2:\alpha$ for some $\alpha,\beta,x$.
\item If $\Gamma\vdash_0 \lambda x:\alpha.\;e:\gamma$, then $\gamma=\forall x:\alpha.\;\beta$ and $\Gamma,x:\alpha\vdash_0 e:\beta$ for some $\alpha,\beta,x$.
\item If $\Gamma\vdash_0 \forall x:\alpha.\;e:\gamma$, then $\gamma=\U_{\imax(\ell_1,\ell_2)}$, $\Gamma\vdash \alpha:\U_{\ell_1}$, and $\Gamma,x:\alpha\vdash \beta:\U_{\ell_2}$ for some $\ell_1,\ell_2,\beta,x$.
\item If $\Gamma\vdash_0 \elet{x:\alpha:=e'}{e}:\beta$, then $\Gamma\vdash e':\alpha$ and $\Gamma\vdash_0 e[e'/x]:\beta$.
\item If $\Gamma\vdash_0 c_{\bar\ell}:\alpha$, then $\alpha=\tau_{\bar\ell}(c)$ (this includes inductive types and defined and axiomatic constants).
\end{enumerate}
\end{lemma}
\begin{proof}\ \\[-1em]
\begin{enumerate}
\item Trivial from the definition.
\item If the last rule was the conversion rule, then the first hypothesis $\Gamma\vdash e:\alpha'$ would have a shorter proof.
\item This follows from the fact that a proof can be weakened by adding $\Delta$ in every step of the proof without increasing the total length, so that a shorter proof of $\Gamma\vdash e:\alpha'$ could be weakened to a short proof of $\Gamma,\Delta\vdash e:\alpha'$.
\item[4-10.] By inversion, we obtain the conclusion in each case without the $\vdash_0$ on the inverted hypotheses. In (7), we know that the derivation $\Gamma,x:\alpha\vdash e:\beta$ is minimal because if $\Gamma,x:\alpha\vdash e:\beta'$ is shorter then we can derive $\Gamma\vdash \lambda x:\alpha.\;e:\forall x:\alpha.\;\beta'$ with a shorter proof, and in (9), if $\Gamma\vdash \elet{x:\alpha:=e'}{e}:\beta'$ is a shorter proof, then $\Gamma\vdash_0 \elet{x:\alpha:=e'}{e}:\beta'$ also has a shorter proof.
\end{enumerate}
\end{proof}

\begin{lemma}[Unique typing]
If $\Gamma\vdash e:\alpha$, then:
\begin{itemize}
\item Either $\Gamma\vdash_0 e:\alpha$, or there is a minimal derivation whose last step is a conversion $\Gamma\vdash\beta\equiv\alpha$ where $\Gamma\vdash_0e:\beta$;
\item If $\Gamma\vdash_0 e:\alpha_1$ and $\Gamma\vdash_0 e:\alpha_2$, then $\Gamma\vdash\alpha_1\equiv\alpha_2$.
\item If $\Gamma\vdash_0 e:\forall x:\beta.\;\alpha_1$ and $\Gamma\vdash_0 e:\forall x:\beta.\;\alpha_2$, then $\Gamma,x:\beta\vdash\alpha_1\equiv\alpha_2$.
\end{itemize}
\end{lemma}
\begin{proof}
By induction on the length of a minimal proof of $\Gamma\vdash e:\alpha$. Note that the two parts of the inductive hypothesis imply that if $\Gamma\vdash_0 e:\alpha'$ then $\Gamma\vdash\alpha'\equiv\alpha$.
\begin{itemize}
\item If the last rule is a base case rule (variable, universe, constant), then it has length 1 and so is minimal; in this case by the inversion lemma the latter part is trivially satisfied.
\item If the last rule is the conversion rule, from hypotheses $\Gamma\vdash e:\beta$ and $\Gamma\vdash\beta\equiv\alpha$, then the inductive hypothesis applies:
\begin{itemize}
\item If $\Gamma\vdash_0 e:\beta$, then the last step is a conversion from $\Gamma\vdash_0 e:\beta$.
\item If there is a minimal derivation of $\Gamma\vdash e:\beta$ via $\Gamma\vdash_0e:\gamma$, $\Gamma\vdash\gamma\equiv\beta$, then we may join the definitional equalities by transitivity to obtain a proof $\Gamma\vdash e:\alpha$ that has the same length as the proof of $\Gamma\vdash e:\beta$ (recall that proof steps for $\Gamma\vdash e\equiv e'$ don't count toward the step count).
\end{itemize}
The second clause is immediate from the IH.
\item If the last step is the application rule, say $\dfrac{\Gamma\vdash e_1:\forall x:\alpha.\;\beta\quad \Gamma\vdash e_2:\alpha}{\Gamma\vdash e_1\;e_2:\beta[e_2/x]}$,
consider also a proof $\dfrac{\Gamma\vdash e_1:\forall x:\alpha'.\;\beta'\quad\Gamma\vdash e_2:\alpha'}{\Gamma\vdash_0 e_1\;e_2:\beta'[e_2/x]}$ (by the inversion lemma). Since all four hypotheses are shorter than the original proof, the inductive hypothesis applies in each case.

We may assume WLOG that $\Gamma\vdash_0 e_2:\alpha'$, because if not it is obtained from conversion on some $\alpha''$, and then since $\forall x:\alpha''.\;\beta'\equiv\forall x:\alpha'.\;\beta'$ we may eliminate the conversion on the right and possibly introduce a conversion on the left for no net increase in the length of the overall proof.

Similarly, since by the inductive hypothesis on $\Gamma\vdash e_2:\alpha$ now $\alpha\equiv\alpha'$, we may arrange it so that the final step of the proof is $\dfrac{\Gamma\vdash e_1:\forall x:\alpha'.\;\beta\quad \Gamma\vdash_0 e_2:\alpha'}{\Gamma\vdash e_1\;e_2:\beta[e_2/x]}$.
By the inductive hypothesis on $\Gamma\vdash e_1:\forall x:\alpha'.\;\beta'$,
\begin{itemize}
\item If both derivations are 
\end{itemize} have $\gamma'\equiv\forall x:\alpha.\;\beta$ and $\alpha'\equiv\alpha$ such that $\Gamma\vdash_0 e_1:\gamma'$ and $\Gamma\vdash_0 e_2:\alpha'$.
\end{itemize}
UNFINISHED
\end{proof}
Now let $\vdash_0\Gamma\ok$ mean that all the types in the context are minimally derived, that is:
$$\frac{}{\vdash_0\cdot\ok}\qquad\frac{\vdash_0\Gamma\ok\quad\Gamma\vdash_0\alpha:\U_\ell}{}\qquad$$
Note that the final rule in such a minimal derivation cannot be the conversion rule, because it has a hypothesis that is a shorter typing of the same expression. Also, if the last rule is weakening, so $\Gamma,x:\beta\vdash_0e:\alpha$ derives from $\Gamma\vdash e:\alpha$, then also $\Gamma\vdash_0e:\alpha$ because any shorter derivation of $\Gamma\vdash e:\alpha'$ could be similarly weakened to a proof of $\Gamma,x:\beta\vdash e:\alpha'$.

UNFINISHED


\subsection{Sort inference}
Our first tool for ensuring that the typing and definitional equality relations are not trivial is to construct a parallel typing and definitional equality judgment that keeps track of a lot more information than the ``official'' one. This will make inductive proofs easier, and then we only have to show that any typing derivation can be ``upgraded'' in this way.
$$\Delta::=\cdot\mid\Delta,x:e:\U_\ell\qquad
\boxed{\Delta\vdash e:\alpha:\U_\ell}$$
$$\frac{\Delta\vdash\alpha:\U_\ell\type\quad\Delta\vdash e:\beta:\U_{\ell'}}{\Delta,x:\alpha:\U_\ell\vdash e:\beta:\U_{\ell'}}\qquad
\frac{\Delta\vdash\alpha:\U_\ell\type}{\Delta,x:\alpha:\U_\ell\vdash x:\alpha:\U_\ell}\qquad
\frac{}{\vdash\U_\ell:\U_{S\ell}\type}$$
$$\frac{\begin{matrix}
\Delta,x:\alpha:\U_{\ell_1}\vdash\beta:\U_{\ell_2}\type\\
\Delta\vdash e_1:\forall x:\alpha.\;\beta:\U_{\ell'}\quad\Delta\vdash e_2:\alpha:\U_{\ell_1}
\end{matrix}}{\Delta\vdash e_1\;e_2:\beta[e_2/x]:\U_{\ell_2}}\qquad
\frac{\Delta,x:\alpha:\U_{\ell_1}\vdash e:\beta:\U_{\ell_2}}{\Delta\vdash\lambda x:\alpha.\;e:\forall x:\alpha.\;\beta:\U_{\imax(\ell_1,\ell_2)}}$$
$$\frac{\Delta,x:\alpha:\U_{\ell_1}\vdash \beta:\U_{\ell_2}\type}{\Delta\vdash\forall x:\alpha.\;\beta:\U_{\imax(\ell_1,\ell_2)}\type}$$
$$\frac{\Delta\vdash e:\alpha:\U_\ell\quad \Delta\vdash \beta:\U_{\ell'}\type\quad \Delta\vdash\alpha\equiv\beta:\U_\ell\quad\ell\equiv\ell'}{\Delta\vdash e:\beta:\U_{\ell'}}$$
In these rules $\Delta\vdash \alpha:\U_\ell\type$ is defined to be $\Delta\vdash \alpha:\U_\ell:\U_{S\ell}$. We also introduce a definitional equality judgment with universe contexts, with a built-in typing of both sides as well:

$$\boxed{\Delta\vdash e\equiv e':\alpha}$$
$$\frac{\Delta\vdash e:\alpha:\U_\ell}{\Delta\vdash e\equiv e:\alpha}\qquad
\frac{\Delta\vdash e\equiv e':\alpha}{\Delta\vdash e'\equiv e:\alpha}\qquad
\frac{\Delta\vdash e_1\equiv e_2:\alpha\quad\Delta\vdash e_2\equiv e_3:\alpha}{\Delta\vdash e_1\equiv e_3:\alpha}$$
$$\frac{\ell\equiv\ell'}{\vdash \U_\ell\equiv\U_{\ell'}:\U_{S\ell}}\qquad
\frac{\Delta\vdash e_1\equiv e'_1:\forall x:\alpha.\;\beta\quad \Delta\vdash e_2\equiv e'_2:\alpha}{\Delta\vdash e_1\;e_2\equiv e'_1\;e'_2:\beta[e_2/x]}$$
$$\frac{\Delta\vdash\alpha\equiv \alpha':\U_{\ell_1}\quad \Delta,x:\alpha:\U_{\ell_1}\vdash e\equiv e':\beta}{\Delta\vdash\lambda x:\alpha.\;e\equiv \lambda x:\alpha'.\;e':\forall x:\alpha.\;\beta}$$
$$\frac{\Delta\vdash \alpha\equiv \alpha':\U_{\ell_1}\quad \Delta,x:\alpha:\U_{\ell_1}\vdash \beta\equiv \beta':\U_{\ell_2}}{\Delta\vdash \forall x:\alpha.\;\beta\equiv \forall x:\alpha'.\;\beta':\U_{\imax(\ell_1,\ell_2)}}$$
$$\frac{\Delta,x:\alpha:\U_\ell\vdash e:\beta:\U_{\ell'}\quad\Delta\vdash e':\alpha:\U_\ell}{\Delta\vdash (\lambda x:\alpha.\;e)\;e'\equiv e[e'/x]:\beta[e'/x]}\qquad
\frac{\Delta\vdash e:\forall y:\alpha.\;\beta:\U_\ell}{\Delta\vdash \lambda x:\alpha.\;e\;x\equiv e:\forall y:\alpha.\;\beta}$$
$$\frac{\Delta\vdash h:p:\P\quad \Delta\vdash h':p:\P}{\Delta \vdash h\equiv h':p}\qquad
\frac{\Delta\vdash e\equiv e':\alpha\quad \Delta\vdash\alpha\equiv\beta:\U_\ell}{\Delta\vdash e\equiv e':\beta}$$

Like $\Gamma\vdash e:\alpha$, we can define a simple context checking judgment:
$$\boxed{\vdash\Delta\ok}\qquad
\frac{}{\vdash\cdot\ok}\qquad
\frac{\Delta\vdash\alpha:\U_\ell\type}{\vdash\Delta,x:\alpha:\U_\ell\ok}$$

Let the notation $[\Delta]$ denotes the context obtained from $\Delta$ by omitting the universes:
$$[\cdot]=\cdot\qquad
[\Delta,x:\alpha:\U_\ell]=[\Delta],x:\alpha$$
And let $\Delta\equiv\Delta'$ mean that the contexts are equivalent except for changing types and levels to definitionally equal ones:
$$\boxed{\Delta\equiv\Delta'}\qquad\frac{}{\cdot\equiv\cdot}\qquad
\frac{\Delta\equiv\Delta'\quad\ell\equiv\ell'\quad\Delta\vdash\alpha\equiv\beta:\U_\ell}{\Delta,x:\alpha:\U_\ell\equiv\Delta',x:\beta:\U_{\ell'}}$$

\begin{lemma}[Substitution and regularity for sort inference]
\begin{enumerate}
\item If $\Delta\vdash e:\alpha:\U_\ell$, then $\vdash \Delta\ok$.
\item If $\Delta\vdash \alpha:\U_\ell\type$, then $\vdash \Delta\ok$.
\item If $\Delta,x:\alpha:\U_\ell\vdash e_1:\beta:\U_{\ell'}$ and $\Delta\vdash e_2:\alpha:\U_\ell$,\\
then $\Delta\vdash e_1[e_2/x]:\beta[e_2/x]:\U_{\ell'}$.
\item If $\Delta,x:\alpha:\U_\ell\vdash e_1\equiv e_1':\beta$ and $\Delta\vdash e_2:\alpha:\U_\ell$,\\
then $\Delta\vdash e_1[e_2/x]\equiv e_1'[e_2/x]:\beta[e_2/x]$.
\item If $\Delta,x:\alpha:\U_\ell\vdash e_1:\beta:\U_\ell$ and $\Delta\vdash e_2\equiv e_2':\alpha$,\\
then $\Delta\vdash e_1[e_2/x]\equiv e_1[e_2'/x]:\beta[e_2/x]$.
\item If $\Delta,x:\alpha:\U_\ell\vdash \beta:\U_{\ell'}\type$ and $\Delta\vdash e_2:\alpha:\U_\ell$, then $\Delta\vdash \beta[e_2/x]:\U_{\ell'}\type$.
\item If $\Delta\vdash e:\alpha:\U_\ell$, then $\Delta\vdash \alpha:\U_\ell\type$.
\item If $\Delta\equiv\Delta'$ then $\vdash\Delta\ok$.
\item $\Delta\equiv\Delta'$ is an equivalence relation.
\item If $\Delta\equiv\Delta'$ and $\Delta\vdash e:\alpha:\U_\ell$ then $\Delta'\vdash e:\alpha:\U_\ell$.
\item If $\Delta\equiv\Delta'$ and $\Delta\vdash e\equiv e':\alpha$ then $\Delta'\vdash e\equiv e':\alpha$.
\item If $\Delta\vdash e:\alpha:\U_\ell$, then $[\Delta]\vdash e:\alpha$.
\item If $\Delta\vdash e:\alpha:\U_\ell$, then $[\Delta]\vdash \alpha:\U_\ell$.
\item If $\Delta\vdash \alpha:\U_\ell\type$, then $[\Delta]\vdash \alpha:\U_\ell$.
\item If $\vdash\Delta\ok$, then $\vdash[\Delta]\ok$.
\item If $\Delta\equiv\Delta'$ then $[\Delta]\equiv[\Delta']$.
\end{enumerate}
\end{lemma}
\begin{proof}\ \\[-7mm]
\begin{itemize}
\item Part (1) an easy induction. Part (2) is a special case of (1).
\item (3) is by induction on the first premise, using the substitution property and (3) in the conversion rule.
\item (8) is a special case of (7).
\item (9) is an easy induction, using (8) in the application case.
\item (10) is by cases on $\Delta$.
\item UNFINISHED
\end{itemize}
\end{proof}

\begin{lemma}[Properties of the context truncation]
\begin{enumerate}
\item If $\Delta\vdash e:\alpha:\U_\ell$, then $[\Delta]\vdash e:\alpha$.
\item If $\Delta\vdash e:\alpha:\U_\ell$, then $[\Delta]\vdash \alpha:\U_\ell$.
\item If $\Delta\vdash \alpha:\U_\ell\type$, then $[\Delta]\vdash \alpha:\U_\ell$.
\item If $\vdash\Delta\ok$, then $\vdash[\Delta]\ok$.
\item If $\Delta\equiv\Delta'$ then $[\Delta]\equiv[\Delta']$.
\end{enumerate}
\end{lemma}
\begin{proof}\ \\[-7mm]
\begin{itemize}
\item (1) and (2) are proven together by induction. The substitution property is used in the application case.
\item (3) is a special case of (1), (4) is by cases using (3).
\end{itemize}
\end{proof}


\begin{lemma}[Sort inference]
\begin{enumerate}
\item If $\Gamma\vdash e:\alpha$, then $\Delta\vdash e:\alpha:\U_\ell$ for some $\Delta,\ell$ such that $[\Delta]=\Gamma$.
\item If $\Gamma\vdash \alpha:\U_\ell$, then $\Delta\vdash \alpha:\U_\ell\type$ for some $\Delta$ such that $[\Delta]=\Gamma$.
\item If $\Gamma\vdash e\equiv e'$, then $\Delta\vdash e\equiv e':\alpha$ for some $\Delta,\alpha$ such that $[\Delta]=\Gamma$.
\end{enumerate}
\end{lemma}
\begin{proof}
All parts are proven by mutual induction.
\begin{itemize}
\item UNFINISHED
\end{itemize}
\end{proof}
The key to why this judgment is relevant is the observation that the conversion rule cannot do anything interesting at the universe level. We want to use this to prove that $\Gamma\vdash\U_\ell\equiv\U_{\ell'}$ implies $\ell\equiv\ell'$.

UNFINISHED

\subsection{Unique typing}\label{sec:unique}
There are a large number of ``natural'' properties about the typing and definitional equality judgments we will want to be true in order to reason that certain judgments are not derivable for ``obvious'' reasons, for example that it is not possible to prove $\vdash\P:\P$ (which is a necessary condition for soundness).

\begin{theorem}[Unique typing]\label{thm:unique}
If $\Gamma\vdash e:\alpha$ and $\Gamma\vdash e:\beta$, then $\Gamma\vdash\alpha\equiv\beta$.
\end{theorem}

Unfortunately, we cannot yet prove this theorem. The critical step is the Church-Rosser theorem, which we will develop in the next section. However, we can set up the induction, which is necessary now since the Church-Rosser theorem will require that this theorem is true, and we will be caught in a circularity unless we are careful about the claims.

We will prove this theorem by induction on the number of alternations between the judgments $\Gamma\vdash e:\alpha$ and $\Gamma\vdash\alpha\equiv\beta$ (which are mutually recursive). Define $\Gamma\vdash_n e:\alpha$ and $\Gamma\vdash_n\alpha\equiv\beta$ by induction on $n\in\N$ as follows:
\begin{itemize}
\item $\Gamma\vdash_0\alpha\equiv\beta$ iff $\alpha=\beta$.
\item $\Gamma\vdash_{n+1}\alpha\equiv\beta$ iff there is a proof of $\Gamma\vdash\alpha\equiv\beta$ using  only $\Gamma\vdash_n e:\alpha$ typing judgments.
\item Assuming $\Gamma\vdash_m\alpha\equiv\beta$ is defined for $m\le n$, $\Gamma\vdash_n e:\alpha$ means that there is a proof of $\Gamma\vdash e:\alpha$ in which all appeals to the conversion rule use $\Gamma\vdash_m\alpha\equiv\beta$ for $m\le n$.
\end{itemize}
So if $\Gamma\vdash_0 e:\alpha$, then there is a proof that does not use the conversion rule at all; if $\Gamma\vdash_1\alpha\equiv\beta$ then there is a proof whose typing judgments do not use the conversion rule; if $\Gamma\vdash_1 e:\alpha$ then there is a proof using only the $1$-provable conversion rule; and so on. We will prove theorem \ref{thm:unique} by induction on this $n$.

\begin{lemma}[$n$-provability basics]
\begin{enumerate}
\item If $m\le n$ then $\Gamma\vdash_m e:\alpha$ implies $\Gamma\vdash_n e:\alpha$.
\item If $m\le n$ then $\Gamma\vdash_m\alpha\equiv\beta$ implies $\Gamma\vdash_n \alpha\equiv\beta$.
\item If $\Gamma\vdash e:\alpha$ then $\Gamma\vdash_n e:\alpha$ for some $n\in\N$.
\item If $\Gamma\vdash\alpha\equiv\beta$ then $\Gamma\vdash_n \alpha\equiv\beta$ for some $n\in\N$.
\end{enumerate}
\end{lemma}
\begin{proof}
(1) is immediate from the definition, (2) follows from (1). (3,4) are proven by a mutual induction on the typing judgment.
\end{proof}
\begin{definition}
Say that $\vdash_n$ has \emph{definitional inversion} if the following properties hold:
\begin{enumerate}
\item If $\Gamma\vdash_n x\equiv y$, then either $x=y$ or $\Gamma\vdash x,y:p$ for some $\Gamma\vdash p:\P$.
\item If $\Gamma\vdash_n \U_\ell\equiv\U_{\ell'}$, then $\ell\equiv\ell'$.
\item If $\Gamma\vdash_n \forall x:\alpha.\;e\equiv\forall x:\alpha'.\;e'$, then $\Gamma\vdash_n \alpha\equiv\alpha'$ and $\Gamma,x:\alpha\vdash_n e\equiv e'$.
\item If $\Gamma\vdash_n c_{\ell}\equiv c_{\ell'}$ (where $c$ is an axiomatic constant like $\mathsf{choice}$ or an inductive type or constructor, not a definition), then $\ell\equiv\ell'$, unless $\Gamma\vdash_n c_{\ell}:p$ for some $\Gamma\vdash_n p:\P$.
\item If $\Gamma\vdash_n \lambda x:\alpha.\;e\equiv\lambda x:\alpha'.\;e'$, then $\Gamma\vdash_n \alpha\equiv\alpha'$ and $\Gamma,x:\alpha\vdash_n e\equiv e'$.
\end{enumerate}
(We will also use the term \emph{unique typing} for this property given lemma \ref{thm:utype}.)
\end{definition}

\begin{theorem}[Unique typing]\label{thm:utype}
If $\vdash_n$ has definitional inversion, and $\Gamma\vdash_n e:\alpha$ and $\Gamma\vdash_n e:\beta$, then $\Gamma\vdash_n\alpha\equiv\beta$.
\end{theorem}
\begin{proof}
By the weakening lemma, we can use instead the judgment $\vdash'_n$ which has no weakening rule.

By induction on the proof of $\Gamma\vdash'_n e:\alpha$ with a secondary induction on $\Gamma\vdash'_n e:\beta$.
\begin{enumerate}
\item If $\Gamma\vdash'_n e:\alpha$ from the conversion rule on $\Gamma\vdash_n\alpha'\equiv\alpha$, $\Gamma\vdash_n e:\alpha'$, then $\Gamma\vdash_n\alpha'\equiv\beta$ by the IH, so $\Gamma\vdash_n\alpha\equiv\beta$ by transitivity. (Similarly if the conversion rule applies on $\Gamma\vdash'_n e:\beta$.)
\item Otherwise, the same typing rule applies in both derivations. The variable, universe, lambda, let, and constant cases are trivial.
\item In the forall case, we have $\Gamma\vdash_n\forall x:\alpha.\;\beta:\U_{\imax(\ell_1,\ell_2)},\U_{\imax(\ell_1',\ell_2')}$ from $\Gamma\vdash\alpha:\U_{\ell_1},\U_{\ell_1'}$ and $\Gamma\vdash\beta:\U_{\ell_2},\U_{\ell_2'}$, and from the inductive hypothesis $\Gamma\vdash_n\U_{\ell_1}\equiv\U_{\ell_1'}$. From definitional inversion, $\ell_1\equiv \ell_1'$ and $\ell_2\equiv \ell_2'$, so $\Gamma\vdash_n\U_{\imax(\ell_1,\ell_2)}\equiv\U_{\imax(\ell_1',\ell_2')}$.
\item In the application case, we have $\Gamma\vdash_n e_1\;e_2:\beta[e_2/x],\beta'[e_2/x]$ from $\Gamma\vdash_n e_1:\forall x:\alpha.\;\beta,\forall x:\alpha'.\;\beta'$ and $\Gamma\vdash_n e_2:\alpha,\alpha'$, and from the inductive hypothesis $\Gamma\vdash_n\forall x:\alpha.\;\beta\equiv\forall x:\alpha'.\;\beta'$. From definitional inversion, $\Gamma\vdash_n\alpha\equiv\alpha'$ and $\Gamma,x:\alpha\vdash_n\beta\equiv\beta'$, so $\Gamma\vdash_n\beta[e_2/x]\equiv\beta'[e_2/x]$.
\end{enumerate}
\end{proof}

Thus, it suffices to prove that $\vdash_n$ has definitional inversion for every $n$ to establish theorem \ref{thm:unique}. We can show the base case:
\begin{lemma}\label{thm:0dinv}
$\vdash_0$ has definitional inversion.
\end{lemma}
\begin{proof}
Since $\Gamma\vdash_0 e\equiv e'$ means $e=e'$, all cases are trivial by inversion on the construction of the term.
\end{proof}

\subsection{The Church-Rosser theorem}\label{sec:church_rosser}
\emph{Note: In this section, we will omit the indices from the provability relation, but we will focus on characterizing the $\equiv$ relation at a particular level. So read $\Gamma\vdash \alpha\equiv\beta$ as $\Gamma\vdash_{n+1} \alpha\equiv\beta$, and $\Gamma\vdash e:\alpha$ as $\Gamma\vdash_n e:\alpha$. Also (and importantly) we will assume that $\vdash_n$ has unique typing, which will prevent the appearance of certain pathologies.}

The standard formulation of the Church-Rosser theorem, when applied to the $\rightsquigarrow$ reduction relation, is not true; under reasonable definitions of reduction, Lean will not have unique normal forms, because of proof irrelevance. (We already saw how this plays out in section \ref{sec:undecidable}). All other substantive reduction rules act on terms the same way regardless of their types. To analyze this, we will split the definitional equality judgment into two parts: A $\beta\eta\delta\zeta\iota$-reduction relation (henceforth abbreviated $\kappa$ reduction), and a relation that does proof irrelevance. The idea is that $\kappa$ reduction satisfies a modified version of the Church-Rosser theorem, while proof irrelevance picks up the pieces, quantifying exactly how non-unique the normal form is.

The $\eta$ reduction relation can sometimes fight against the $\iota$ reduction in the sense that it is possible for a K-like eliminator to reduce in two ways, where the $\eta$ reduced form cannot reduce, for example with the following reductions, using $\rec_{a=}:\forall C.\;C\;a\to \forall b.\;a=b\to C\;b$:
\begin{align*}
&\lambda h:a=a.\;\rec_{a=}\;C\;e\;a\;h\rightsquigarrow_\eta\rec_{a=}\;C\;e\;a\\
&\lambda h:a=a.\;\rec_{a=}\;C\;e\;a\;h\rightsquigarrow_\iota\lambda h:a=a.\;e
\end{align*}

To resolve this, we will require that $\rec$ and $\lift$ always have their required number of parameters. To accomplish this, we will slightly modify the language to remove $\rec_P$ the function and replace it with a fully applied form $\rec_P(C,e,p,x)$. (We will use the notation $f(x)$ instead of $f\;x$ for these ``atomic applications''.) The transformation is as follows:
\begin{itemize}
\item If $e$ is a list of terms of length $n$ and $\rec_P$ has $m\ge n$ arguments, then $\overline{\rec_P\;e}=\lambda x::\alpha.\;\rec_P(e,x)$ where $x$ is the remaining $n-m$ arguments, with type $\alpha$ according to the specification of $P$.
\item If $e$ is a list of terms of length $n\le 6$ (note that $\lift$ has 6 arguments), then $\overline{\lift\;e}=\lambda x::\alpha.\;\lift(e,x)$ where $x$ is the remaining $6-n$ arguments.
\item Otherwise, the transformation is recursive in subterms: $\overline x=x$, $\overline{\lambda x:\alpha.\;e}=\lambda x:\overline{\alpha}.\;\overline{e}$, etc. 
\end{itemize}
The reverse translation maps $\underline{\rec_P(C,e,p,x)}=\rec_P\;C\;e\;p\;x$ and $\underline{\lift(\alpha,R,\beta,f,h,q)}=\lift\;\alpha\;R\;\beta\;f\;h\;q$ and leaves all other forms unchanged. The typing rules are extended in the obvious way to the new forms. The relevant properties of this transformation are:

\begin{lemma}[Properties of the $\rec$-normal form]
\begin{itemize}
\item If $\Gamma\vdash e:\alpha$ in the modified language, then $\underline{\Gamma}\vdash \underline{e}:\underline{\alpha}$ in the original language and $\overline{(\underline{e})}=e$.
\item If $\Gamma\vdash e:\alpha$ in the original language, then $\overline{\Gamma}\vdash \overline{e}:\overline{\alpha}$ and $\Gamma\vdash \underline{(\overline{e})}\equiv e$. (In fact, the proof of equivalence uses only $\eta$.)
\item If $\Gamma\vdash e\equiv e'$ in the modified language, then $\underline{\Gamma}\vdash \underline{e}\equiv\underline{e'}$.
\item If $\Gamma\vdash e\equiv e'$ in the original language, then $\overline{\Gamma}\vdash \overline{e}\equiv\overline{e'}$.
\end{itemize}
\end{lemma}

With this new language, the problem above is rejected on syntax grounds:
\begin{align*}
&\lambda h:a=a.\;\rec_{a=}(C,e,a,h)\rightsquigarrow_\iota\lambda h:a=a.\;e\\
&\lambda h:a=a.\;\rec_{a=}(C,e,a,h)\not\rightsquigarrow_\eta\rec_{a=}(C,e,a)
\end{align*}
where the second reduction doesn't work because $\rec_{a=}(C,e,a,h)$ is not an application, so the $\eta$ rule doesn't apply (and $\rec_{a=}(C,e,a)$ is not syntactically correct because it has the wrong number of arguments).

\begin{remark}
Rather than modifying the language, we could have instead modified the eta rule to not apply when the argument is a recursor with the correct number of arguments, but this approach of using application-like forms that are not applications seems clearer to the author.
\end{remark}

The $\kappa$ reduction relation is defined on the modified language, with compatibility rules such as these for every syntax operator (including $\rec_P(e)$ and $\lift(e)$):
$$\boxed{\Gamma\vdash e\rightsquigarrow_\kappa e'}\qquad
\frac{\Gamma\vdash e_1 \rightsquigarrow_\kappa e_1'}{\Gamma\vdash e_1\;e_2\rightsquigarrow_\kappa e_1'\;e_2}\qquad
\frac{\Gamma\vdash e_2 \rightsquigarrow_\kappa e_2'}{\Gamma\vdash e_1\;e_2\rightsquigarrow_\kappa e_1\;e_2'}$$
$$\frac{\Gamma\vdash \alpha \rightsquigarrow_\kappa\alpha'}{\Gamma\vdash \lambda x:\alpha.\;e\rightsquigarrow_\kappa \lambda x:\alpha'.\;e}\qquad
\frac{\Gamma,x:\alpha\vdash e \rightsquigarrow_\kappa e'}{\Gamma\vdash \lambda x:\alpha.\;e\rightsquigarrow_\kappa \lambda x:\alpha.\;e'}\qquad\dots$$
The substantive rules are:
$$(\beta)\ \frac{}{\Gamma\vdash (\lambda x:\alpha.\;e)\;e'\rightsquigarrow_\kappa e[e'/x]}\qquad
(\eta)\ \frac{\Gamma,x:\alpha\vdash h\equiv_p x}{\Gamma\vdash \lambda x:\alpha.\;e\;h\rightsquigarrow_\kappa e}$$
$$(\delta)\ \frac{\mathsf{def}\;c:\alpha:=e}{\Gamma\vdash c\rightsquigarrow_\kappa e}\qquad
(\zeta)\ \frac{}{\Gamma\vdash \elet{x:\alpha:=e'}{e}\rightsquigarrow_\kappa e[e'/x]}$$
$$(\iota)\ \frac{P\mbox{ is non-K inductive with ctor }c}{\Gamma\vdash \rec_P(C,e,p,c\;b)\rightsquigarrow_\kappa e_c\;b\;v}\qquad
(\iota_q)\ \frac{}{\Gamma\vdash \lift(R,f,h,\mk_R\;a)\rightsquigarrow_\kappa f\;a}$$
$$(K)\ \frac{P\mbox{ is K-like inductive}}{\Gamma\vdash \rec_P(C,e,p,h)\rightsquigarrow_\kappa e\;\inv[p,h]\;v}\qquad
(\iota_K)\ \frac{P\mbox{ is K-like inductive}}{\Gamma\vdash\inv_i\;(\intro\;b)\rightsquigarrow_\kappa b_i}$$

See section \ref{sec:inductive} for the variable names and types used in the regular $\iota$ rule.

We have an alternate $\iota$ rule for K-like inductives, where $\inv[p,h]$ is a sequence of terms such that $\intro\;\inv[p,h]\equiv h$ (by proof irrelevance) and $\inv_i[p,\intro\;b]\equiv b_i$. By the definition of a K-like inductive, every argument to the $\intro$ constructor is either propositional, or appears as one of the parameters $p_i$ to the inductive family. We define $\inv_i[p,h]:=p_j$ when the $i$th constructor argument is non-propositional and appears at position $j$ in the output type, and $\inv_i[p,h]=\inv_i\;h$ for the propositions, where $\inv_i$ is an atomic projection function. These $\inv_i$ projection operators can be defined in the original language using the recursor, like we demonstrated for $\acc$ in section \ref{sec:undecidable}, but we will treat them as constants of the modified language.

The proof irrelevance relation deals with all the ways that normal forms can fail to be unique. Specifically, this relation is responsible for changing universe levels and changing proofs.
$$\boxed{\Gamma\vdash e\equiv_p e'}$$
$$\frac{\Gamma\vdash e:\alpha}{\Gamma\vdash e\equiv_p e}\qquad
\frac{\Gamma\vdash\alpha\equiv_p\alpha'\quad \Gamma,x:\alpha\vdash e\equiv_p e'}{\Gamma\vdash \forall x:\alpha.\;e\equiv_p \forall x:\alpha'.\;e'}\qquad
\frac{\Gamma\vdash e_1\equiv_p e_1'\quad \Gamma\vdash e_2\equiv_p e_2'}{\Gamma\vdash e_1\;e_2\equiv_p e_1'\;e_2'}\qquad\dots$$
$$\frac{\ell\equiv\ell'}{\vdash \U_\ell\equiv_p\U_{\ell'}}\qquad
\frac{\Gamma\vdash\alpha\equiv\alpha'\quad \Gamma,x:\alpha\vdash e\equiv_p e'}{\Gamma\vdash \lambda x:\alpha.\;e\equiv_p \lambda x:\alpha'.\;e'}\qquad
\frac{\Gamma\vdash p:\P\quad \Gamma\vdash h:p\quad \Gamma\vdash h':p}{\Gamma \vdash h\equiv_p h'}$$
Note also that this relation allows full definitional equality in the domain of a lambda, that is, it requires that $\Gamma\vdash \alpha\equiv\alpha'$ instead of $\Gamma\vdash \alpha\equiv_p\alpha'$ like the other rules. To give a hint on why this is relevant, consider the following reduction sequence:

\begin{align*}
&\lambda x:\alpha.\;(\lambda y:\beta.\;e)\;x\rightsquigarrow_\eta\lambda y:\beta.\;e\\
&\lambda x:\alpha.\;(\lambda y:\beta.\;e)\;x\rightsquigarrow_\beta\lambda x:\alpha.\;e[x/y]=\lambda y:\alpha.\;e
\end{align*}
(We view $\alpha$-equivalent terms as syntactically equal.) By reducing the expression in two ways, we obtain the ``same'' expression $\lambda y.\;e$, but the type annotation is different, and although we know from the application rule that $\alpha\equiv\beta$, this equivalence may involve the full strength of the type system to prove. These two terms are, however, $\equiv_p$-equivalent, and this is close enough to equal for us to prove the main theorems.

\begin{lemma}[Regularity of reductions]
\begin{enumerate}
\item If $\Gamma\vdash e:\alpha$ and $\Gamma\vdash e\rightsquigarrow_\kappa e'$, then $\Gamma\vdash e\equiv e':\alpha$.
\item $\equiv_p$ is an equivalence relation.
\item If $\Gamma\vdash e\equiv_p e'$, then $\Gamma\vdash e\equiv e'$.
\item\label{item:p_subst} If $\Gamma,x:\alpha\vdash e_1\equiv_p e_1'$ and $\Gamma\vdash e_2\equiv_p e_2'$ then $\Gamma\vdash e_1[e_2/x]\equiv_p e_1'[e_2'/x]$.
\end{enumerate}
\end{lemma}
\begin{proof}
All parts are easy inductions.
\end{proof}
Note that the first part implies subject reduction for $\rightsquigarrow_\kappa$.

\begin{theorem}[Church-Rosser property]\label{thm:church_rosser}
If $\Gamma\vdash e:\alpha$, and $e\rightsquigarrow_\kappa^* e_1$ and $e\rightsquigarrow_\kappa^* e_2$, then there exists $e_1'$ and $e_2'$ such that $\Gamma\vdash e_1'\equiv_p e_2'$, and $e_1\rightsquigarrow_\kappa^* e_1'$ and $e_2\rightsquigarrow_\kappa^* e_2'$.
\end{theorem}
The proof follows the Tait--Martin-L\"{o}f method, extended to all the $\kappa$ rules. Define the parallel reduction $\gg_\kappa$ by the following rules:
$$\frac{}{\Gamma\vdash x\gg_\kappa x}\qquad
\frac{\Gamma\vdash \alpha\gg_\kappa\alpha'\quad \Gamma,x:\alpha\vdash e\gg_\kappa e'}{\Gamma\vdash \lambda x:\alpha.\;e\gg_\kappa \lambda x:\alpha'.\;e'}\qquad
\frac{\Gamma\vdash e_1\gg_\kappa e_1'\quad \Gamma\vdash e_2\gg_\kappa e_2'}{\Gamma\vdash e_1\;e_2\gg_\kappa e_1'\;e_2'}\qquad\dots$$
$$\frac{\Gamma,x:\alpha\vdash e_1\gg_\kappa e_1'\quad \Gamma\vdash e_2\gg_\kappa e_2'}{\Gamma\vdash (\lambda x:\alpha.\;e_1)\;e_2\gg_\kappa e_1'[e_2'/x]}\qquad
\frac{x\notin FV(e)\quad \Gamma,x:\alpha\vdash h\equiv_p x\quad \Gamma\vdash e\gg_\kappa e'}{\Gamma\vdash \lambda x:\alpha.\;e\;h\gg_\kappa e'}$$
$$\frac{\Gamma\vdash e_2[e_1/x]\gg_\kappa e'}{\Gamma\vdash \elet{x:\alpha:=e_1}{e_2}\gg_\kappa e'}\qquad
\frac{\mathsf{def}\;c:\alpha:=e\quad \Gamma\vdash e\gg_\kappa e'}{\Gamma\vdash c\gg_\kappa e'}$$
$$\frac{\Gamma\vdash f\gg_\kappa f'\quad \Gamma\vdash a\gg_\kappa a'}{\Gamma\vdash \lift(R,f,h,\mk_R\;a)\gg_\kappa f'\;a'}\qquad
\frac{\begin{matrix}
P\mbox{ is non-K inductive with ctor }c\\
\Gamma\vdash C,e,b,p\gg_\kappa C',e',b',p'
\end{matrix}}{\Gamma\vdash \rec_P(C,e,p,c\;b)\gg_\kappa e'\;b'\;v'}$$
$$\frac{\begin{matrix}
P\mbox{ is K-like inductive}\\
\Gamma\vdash C,e,p,h\gg_\kappa C',e',p',h'
\end{matrix}}{\Gamma\vdash \rec_P(C,e,p,h)\gg_\kappa e_c'\;\inv[p',h']\;v'}\qquad
\frac{\begin{matrix}
P\mbox{ is K-like inductive}\\
\Gamma\vdash b_i\gg_\kappa b_i'
\end{matrix}}{\Gamma\vdash \inv_i\;(\intro\;b)\gg_\kappa b_i'}$$

The ellipsis on the first line abbreviates compatibility rules for all the term constructors, recursing into all subterms like in the examples for lambda and application. All the substantive rules also follow a similar pattern: for each substantive rule in $\rightsquigarrow_\kappa$, there is a corresponding rule where after applying the $\rightsquigarrow_\kappa$ rule all variables on the RHS are $\gg_\kappa$ evaluated to the primed versions, and these are what end up in the target expression. (Note that in the $\iota$ rule, $v$ is a term that mentions $e$ and $p$; these are replaced by the primed versions in $v'$.)

In addition, we define the following ``complete reduction'' $\Gamma\vdash e\ggg_\kappa e'$ by exactly the same rules as $\gg_\kappa$, except that the compatibility rules only apply if none of the substantive rules are applicable. This makes $\ggg_\kappa$ almost deterministic (producing a unique $e'$ given $e$), except that the $\equiv_p$ hypothesis in the $\iota$ rule allows some freedom of choice of the parameters $b$.

It is easy to prove the following properties by induction:
\begin{lemma}[Properties of $\gg_\kappa$]\label{thm:gg_prop}
\begin{enumerate}
\item If $\Gamma\vdash e:\alpha$, then $\Gamma\vdash e\gg_\kappa e$.
\item\label{item:red_gg} If $\Gamma\vdash e\rightsquigarrow_\kappa e'$ then $\Gamma\vdash e\gg_\kappa e'$.
\item\label{item:gg_red} If $\Gamma\vdash e\gg_\kappa e'$ then $\Gamma\vdash e\rightsquigarrow_\kappa^* e'$.
\item\label{item:gg_subst} If $\Gamma,x:\alpha\vdash e_1\gg_\kappa e_1'$ and $\Gamma\vdash e_2\gg_\kappa e_2'$ (where $\Gamma\vdash e_2:\alpha$) then\\ $\Gamma\vdash e_1[e_2/x]\gg_\kappa e_1'[e_2'/x]$.
\item\label{item:ggg_gg} If $\Gamma\vdash e\ggg_\kappa e'$, then $\Gamma\vdash e\gg_\kappa e'$.
\item\label{item:ggg_ex} If $\Gamma\vdash e:\alpha$, then $\Gamma\vdash e\ggg_\kappa e'$ for some $e'$.
\end{enumerate}
\end{lemma}

\begin{lemma}[Compatibility of $\gg_\kappa$ with $\equiv_p$]\label{thm:gg_compat}
If $\Gamma\vdash e_1\equiv_p e_3\gg_\kappa e_2$, then there exists $e_4$ such that $\Gamma\vdash e_1\gg_\kappa e_4\equiv_p e_2$.
\end{lemma}
\begin{proof}
By induction on $e_1\equiv_p e_3$ and inversion on $e_3\gg_\kappa e_2$. (We will omit the contexts from the relations.)
\begin{itemize}
\item If $e_1\equiv_p e_3=e_1$ by the reflexivity rule, then $e_1\gg_\kappa e_2\equiv_p e_2$.
\item If $e_1\equiv_p e_3$ by the proof irrelevance rule, then $e_3:p:\P$, so $e_2:p:\P$ as well and hence $e_1\gg_\kappa e_1\equiv_p e_2$.
\item If $e_1\equiv_p e_3$ and $e_3\gg_\kappa e_2$ both use the same compatibility rule, then it is immediate from the induction hypothesis.
\item If $e_1:p:\P$ is a proof, then $e_1\gg_\kappa e_1\equiv_p e_2$. (We will thus assume that $e_1$ is not a proof in later cases.)
\item If $\lambda x:\alpha_1.\;e_1\equiv_p\lambda x:\alpha_3.\;e_3\gg_\kappa\lambda x:\alpha_2.\;e_2$ by the lambda compatibility rule, then $\alpha_1\equiv\alpha_3\gg_\kappa\alpha_2$ and $e_1\equiv_p e_3\gg_\kappa e_2$, and by the IH we have $e_1\gg_\kappa e_4\equiv_p e_2$, so $\lambda x:\alpha_1.\;e_1\gg_\kappa\lambda x:\alpha_3.\;e_4\equiv_p\lambda x:\alpha_2.\;e_2$.
\item If $(\lambda x:\alpha_1.\;e_1)\;e_1'\equiv_p(\lambda x:\alpha_3.\;e_3)\;e_3'\gg_\kappa e_2[e_2'/x]$ where $e_1\equiv_p e_2\gg_\kappa e_3$, $e_1'\equiv_p e_2'\gg_\kappa e_3'$ and $\alpha_1\equiv\alpha_3$, then $(\lambda x:\alpha_1.\;e_1)\;e_1'\gg_\kappa e_1[e_1'/x]\equiv_p e_2[e_2'/x]$. (Other cases are similar, when the $\equiv_p$ is proven by compatibility rules and the $\gg_\kappa$ is a substantive rule.)
\item If $\lambda x:\alpha_1.\;e_1\;h_1\equiv_p\lambda x:\alpha_3.\;e_3\;h_3\gg_\kappa e_2$ where $e_1\equiv_p e_3\gg_\kappa e_2$ and $h_1\equiv_p h_3\equiv_p x$, then by the IH $e_1\gg_\kappa e_4\equiv_p e_2$ so that $\lambda x:\alpha_1.\;e_1\;h_1\gg_\kappa e_4\equiv_p e_2$.
\item If $\lift(R_1,\beta_1,f_1,h_1,q_1)\equiv_p\lift(R_3,\beta_3,f_3,h_3,\mk_R\;a_3)$ where $q_1\equiv_p \mk_R\;a_3$ by proof irrelevance, then $\beta:\P$ so $e_1:\beta$ is a proof. (Note: we are using that $\vdash_n$ has unique typing here.)
\item If $\rec_P(C_1,e_1,p_1,h_1)\equiv_p\rec_P(C_3,e_3,p_3,c\;b_3)\gg_\kappa (e_2)_c\;b_2\;v_2$ where $P$ is non-K inductive and $h_1\equiv_p c\;b_3$ by proof irrelevance, it is a small eliminator, so $\rec_P(C_1,e_1,p_1,h_1)$ is a proof.
\item If $e_1\equiv_p\inv_i\;(\intro\;b_3)$, then $e_1$ is a proof, since the $\inv_i$ function is only defined at propositional arguments.
\end{itemize}
\end{proof}
\begin{lemma}[Triangle lemma]\label{thm:tri}
If $\Gamma\vdash e:\alpha$, $e\gg_\kappa e'$, and $e\ggg_\kappa e^\bullet$, then there exists $e^\circ$ such that $\Gamma\vdash e'\gg_\kappa e^\circ\equiv_p e^\bullet$.
\end{lemma}
\begin{proof}
By induction on $e\ggg_\kappa e^\bullet$ and inversion on $e\gg_\kappa e'$.
\begin{itemize}
\item If $x\lll_\kappa x\gg_\kappa x$, then $x\gg_\kappa x\equiv_p x$.
\item If $e\ggg_\kappa e^\bullet$ by the beta rule:
\begin{itemize}
\item If $e_1^\bullet[e_2^\bullet/x]\lll_\kappa(\lambda x:\alpha.\;e_1)\;e_2\gg_\kappa e_1'[e_2'/x]$ by the beta rule, then $e_1'\gg_\kappa e_1^\circ$ and $e_2'\gg_\kappa e_2^\circ$ by the inductive hypothesis, so $e_1'[e_2'/x]\gg_\kappa e_1^\circ[e_2^\circ/x]\equiv_p e_1^\bullet[e_2^\bullet/x]$ by the substitution property.
\item If $e_1^\bullet[e_2^\bullet/x]\lll_\kappa(\lambda x:\alpha.\;e_1)\;e_2\gg_\kappa (\lambda x:\alpha.\;e_1')\;e_2'$ by the application rule and lambda rule, then $(\lambda x:\alpha.\;e_1')\;e_2'\gg_\kappa e_1^\circ[e_2^\circ/x]\equiv_p e_1^\bullet[e_2^\bullet/x]$ by the beta rule for $\gg_\kappa$ and the IH.
\item If $e_1^\bullet\;h[e_2^\bullet/x]\lll_\kappa(\lambda x:\alpha.\;e_1\;h)\;e_2\gg_\kappa e_1'\;e_2'$ by the application rule and eta rule, then $e_1'\;e_2'\gg_\kappa e_1^\circ\;e_2^\circ\equiv_p e_1^\bullet\;h[e_2^\bullet/x]$ because $e_2^\circ\equiv_p e_2^\bullet=x[e_2^\bullet/x]\equiv_p h[e_2^\bullet/x]$.
\end{itemize}
\item If $e\ggg_\kappa e^\bullet$ by the eta rule:
\begin{itemize}
\item If $e^\bullet\lll_\kappa\lambda x:\alpha.\;e\;h\gg_\kappa e'$ by the eta rule, then $e'\gg_\kappa e^\circ\equiv_p e^\bullet$.
\item If $e^\bullet\lll_\kappa\lambda x:\alpha.\;e\;h\gg_\kappa \lambda x:\alpha'.\;e'\;h'$ by the lambda rule and application rule, then $\lambda x:\alpha'.\;e'\;h'\gg_\kappa e^\circ\equiv_p e^\bullet$.
\item If $\lambda y:\beta^\bullet.\;e^\bullet\lll_\kappa\lambda x:\alpha.\;(\lambda y:\beta.\;e)\;h\gg_\kappa \lambda x:\alpha'.\;e'[h/y]$ by the lambda rule and beta rule, then $\lambda x:\alpha'.\;e'[h/y]\gg_\kappa \lambda x:\alpha^\circ.\;e^\circ[h/y]\equiv_p$\\$\lambda x:\beta^\bullet.\;e^\bullet[x/y]=\lambda y:\beta^\bullet.\;e^\bullet$. (Here we have used the $\lambda$ rule for $\equiv_p$ to equate $\alpha^\circ\equiv\beta^\bullet$, which are def.eq. because $\alpha$ and $\beta$ are.)
\end{itemize}
\item If $e^\bullet\lll_\kappa c\gg_\kappa e'$ by the delta rule, then $e'\gg_\kappa e^\circ\equiv_p e^\bullet$.
\item If $e\ggg_\kappa e^\bullet$ by the zeta rule:
\begin{itemize}
\item If $e_1^\bullet[e_2^\bullet/x]\lll_\kappa\elet{x:\alpha:=e_1}{e_2}\gg_\kappa e_2'[e_1'/x]$ by the zeta rule, then $e_1'[e_2'/x]\gg_\kappa e_1^\circ[e_2^\circ/x]\equiv_p e_1^\bullet[e_2^\bullet/x]$.
\item If $e_1^\bullet[e_2^\bullet/x]\lll_\kappa\elet{x:\alpha:=e_1}{e_2}\gg_\kappa \elet{x:\alpha':=e_1'}{e_2'}$ by the let compatibility rule, then $\elet{x:\alpha':=e_1'}{e_2'}\gg_\kappa e_1^\circ[e_2^\circ/x]\equiv_p e_1^\bullet[e_2^\bullet/x]$ by the zeta rule.
\end{itemize}
\item If $e\ggg_\kappa e^\bullet$ by the non-K inductive iota rule:
\begin{itemize}
\item If $e_c^\bullet\;b^\bullet\;v^\bullet\lll_\kappa \rec_P(C,e,p,c\;b)\gg_\kappa e_c'\;b'\;v'$ by the iota rule, then $e_c'\;b'\;v'\gg_\kappa e_c^\circ\;b^\circ\;v^\circ\equiv_p e_c^\bullet\;b^\bullet\;v^\bullet$.
\item If $e_c^\bullet\;b^\bullet\;v^\bullet\lll_\kappa \rec_P(C,e,p,c\;b)\gg_\kappa \rec_P(C',e',p',c\;b')$ by the $\rec_P$ compatibility rule, then $\rec_P(C',e',p',c\;b')\gg_\kappa e_c^\circ\;b^\circ\;v^\circ\equiv_p e_c^\bullet\;b^\bullet\;v^\bullet$ by the iota rule.
\end{itemize}
\item If $e\ggg_\kappa e^\bullet$ by the quotient iota rule:
\begin{itemize}
\item If $f^\bullet\;a^\bullet\lll_\kappa \lift(R,f,h,\mk_R\;a)\gg_\kappa f'\;a'$ by the iota rule, then $f'\;a'\gg_\kappa f^\circ\;a^\circ\equiv_p f^\bullet\;a^\bullet$.
\item If $f^\bullet\;a^\bullet\lll_\kappa \lift(R,f,h,\mk_R\;a)\gg_\kappa\lift(R',f',h',\mk_{R'}\;a')$ by the $\lift$ compatibility rule, then we have $q'\gg_\kappa q^\circ\equiv_p q^\bullet$ for $q\in\{C,e,p,h\}$, and $\lift(R',f',h',\mk_{R'}\;a')\gg_\kappa f^\circ\;a^\circ\equiv_p f^\bullet\;a^\bullet$.
\end{itemize}
\item If $e\ggg_\kappa e^\bullet$ by the K rule:
\begin{itemize}
\item If $e_c^\bullet\;\inv[p^\bullet,h^\bullet]\;v^\bullet\lll_\kappa \rec_P(C,e,p,h)\gg_\kappa e_c'\;\inv[p',h']\;v'$ by the iota rule, then $e_c'\;\inv[p',h']\;v'\gg_\kappa e_c^\circ\;\inv[p^\circ,h^\circ]\;v^\circ\equiv_p e_c^\bullet\;\inv[p^\bullet,h^\bullet]\;v^\bullet$.
\item If $e_c^\bullet\;\inv[p^\bullet,h^\bullet]\;v^\bullet\lll_\kappa \rec_P(C,e,p,h)\gg_\kappa \rec_P(C',e',p',h')$ by the $\rec_P$ compatibility rule, then $\rec_P(C',e',p',h')\gg_\kappa e_c^\circ\;\inv[p^\circ,h^\circ]\;v^\circ\equiv_p e_c^\bullet\;\inv[p^\bullet,h^\bullet]\;v^\bullet$ by the iota rule.
\end{itemize}
\item If $e\ggg_\kappa e^\bullet$ by the K-iota rule:
\begin{itemize}
\item If $b_i^\bullet\lll_\kappa \inv_i\;(c\;b)\gg_\kappa b_i'$ by the iota rule, then $b_i'\gg_\kappa b_i^\circ\equiv_p b_i^\bullet$ by the IH.
\item If $b_i^\bullet\lll_\kappa \inv_i\;(c\;b)\gg_\kappa \inv_i\;(c\;b')$ by compatibility rules, then $\inv_i\;(c\;b')\gg_\kappa b_i^\circ\equiv_p b_i^\bullet$ by the K-iota rule.
\end{itemize}
\item If $e\ggg_\kappa e^\bullet$ by a compatibility rule:
\begin{itemize}
\item If $e_1^\bullet\;e_2^\bullet\lll_\kappa e_1\;e_2\gg_\kappa e_1'\;e_2'$ by the application rule, then $e_1'\;e_2'\gg_\kappa e_1^\circ\;e_2^\circ\equiv_p e_1^\bullet\;e_2^\bullet$.
\item If $\forall x:\alpha^\bullet.\;e^\bullet\lll_\kappa \forall x:\alpha.\;e\gg_\kappa \forall x:\alpha'.\;e'$ by the forall rule, then $\forall x:\alpha'.\;e'\gg_\kappa \forall x:\alpha^\circ.\;e^\circ\equiv_p \forall x:\alpha^\bullet.\;e^\bullet$.
\item Other compatibility rules follow the same pattern.
\end{itemize}
\end{itemize}
\end{proof}
The main proof of Church-Rosser is a corollary of lemma \ref{thm:tri}, and does not differ substantially from the usual proof putting diamonds together, because the additional complication of having $\equiv_p$ at the bottom of the diamond commutes with all the other reductions.
\begin{proof}[of theorem \ref{thm:church_rosser}]
We prove in succession the following theorems:
\begin{enumerate}
\item If $\Gamma\vdash e:\alpha$, and $e_1\ll_\kappa e\gg_\kappa e_2$, then $\exists e_1'\;e_2'.\; e_1\gg_\kappa e_1'\equiv_p e_2'\ll_\kappa e_2$.
\item If $\Gamma\vdash e:\alpha$, and $e_1\ll_\kappa^* e\gg_\kappa e_2$, then $\exists e_1'\;e_2'.\; e_1\gg_\kappa e_1'\equiv_p e_2'\ll_\kappa^* e_2$.
\item If $\Gamma\vdash e:\alpha$, and $e_1\ll_\kappa^* e\gg_\kappa^* e_2$, then $\exists e_1'\;e_2'.\; e_1\gg_\kappa^* e_1'\equiv_p e_2'\ll_\kappa^* e_2$.
\item If $\Gamma\vdash e:\alpha$, and $e_1\leftsquigarrow_\kappa^*e\rightsquigarrow_\kappa^* e_2$, then $\exists e_1'\;e_2'.\; e_1\rightsquigarrow_\kappa^* e_1'\equiv_p e_2'\leftsquigarrow_\kappa^* e_2$.
\end{enumerate}
(4) is the theorem we want.
\begin{enumerate}
\item If $e\gg_\kappa e_1,e_2$, then by lemma \ref{thm:tri} there exists $e_1',e_2'$ such that $e_i\gg_\kappa e_i'$ and $e_1'\equiv_p e^\bullet\equiv_p e_2'$. But then $e_1'\equiv_p e_2'$ are as desired. 
\item By induction on $e\gg_\kappa^* e_1$. If $e\gg_\kappa^* e_1\gg_\kappa e_3$ and we have inductively that $e_1\gg_\kappa e_1'\equiv_p e_2'\ll_\kappa^* e_2$, then by applying (1) to $e_3\ll_\kappa e_1\gg_\kappa e_1'$ we obtain $e_3\gg_\kappa e_3'\equiv_p e_1''\ll_\kappa e_1'$, and by lemma \ref{thm:gg_compat} applied to $e_1''\ll_\kappa e_1'\equiv_p e_2'$ we obtain $e_1''\equiv_p e_2''\ll_\kappa e_2'$ so that  $e_3\gg_\kappa e_3'\equiv_p e_1''\equiv_p e_2''\ll_\kappa e_2'\ll_\kappa^* e_2$.
\item By induction on $e\gg_\kappa^* e_2$. The proof is the same as (2), replacing lemma \ref{thm:gg_compat} for the analogous statement for $\gg_\kappa^*$, i.e. if $e_1\gg_\kappa^*e_2$ and $e_1\equiv_p e_1'$ then there exists $e_2'$ such that $e_1'\gg_\kappa^*e_2'\equiv_p e_1'$. This follows by induction on lemma \ref{thm:gg_compat}.
\item  The equivalence of (3) and (4) comes from properties \ref{item:red_gg} and \ref{item:gg_red} of lemma \ref{thm:gg_prop}.
\end{enumerate}
\end{proof}

Now say that $\Gamma\vdash e_1\equiv_\kappa e_2$ if $\Gamma\vdash e_1,e_2:\alpha$ for some $\alpha$, and there exists $e_1',e_2'$ such that $\Gamma\vdash e_1\rightsquigarrow_\kappa^* e_1'\equiv_p e_2'\leftsquigarrow_\kappa^* e_2$. This relation is obviously reflexive and symmetric and implies $\Gamma\vdash e_1\equiv e_2$, and the Church-Rosser property implies it is also transitive.

\begin{theorem}[Completeness of the $\kappa$ reduction]\label{thm:ckappa}
$\Gamma\vdash e\equiv e'$ if and only if $\Gamma\vdash e\equiv_\kappa e'$ (in the modified language).
\end{theorem}
\begin{proof}
The reverse direction follows from regularity lemmas observed above. The forward direction is by induction on $\equiv$.
\begin{itemize}
\item The equivalence relation rules are immediate since $\equiv_\kappa$ is an equivalence relation (by the Church-Rosser property).
\item For the compatibility rules, since both $\equiv_p$ and $\rightsquigarrow_\kappa$ have compatibility rules, this property passes to $\equiv_\kappa$. Thus, for example in the lambda case, we have $\Gamma\vdash\lambda x:\alpha.\;e\equiv_\kappa\lambda x:\alpha.\;e'$ since $\Gamma,x:\alpha\vdash e\equiv_\kappa e'$ from the IH, and similarly $\Gamma\vdash\lambda x:\alpha.\;e'\equiv_\kappa\lambda x:\alpha'.\;e'$, so by transitivity $\Gamma\vdash\lambda x:\alpha.\;e\equiv_\kappa\lambda x:\alpha'.\;e'$.
\item The universe changing rules (for constants and $\U_\ell$) are in $\equiv_p$.
\item The $\beta$ and $\eta$ rules are in $\rightsquigarrow_\kappa$, and the proof irrelevance rule is in $\equiv_p$. All the other equivalence rules are also introduced in $\rightsquigarrow_\kappa$.
\item For K-like eliminators, we must show $\rec_P(C,e,p,\intro\;b)\equiv_\kappa e\;b\;v$. From the K rule we have $\rec_P(C,e,p,\intro\;b)\equiv_\kappa e\;\inv[p,c\;b]\;v$ so it suffices to show $\inv_i[p,\intro\;b]\equiv_\kappa b_i$ for each $i$. If $b_i$ is propositional then this is by proof irrelevance, otherwise $\inv_i[p,\intro\;b]=p_j$, and the well-typedness of $\rec_P(C,e,p,\intro\;b)$ implies that $\Gamma\vdash_n b_i\equiv p_j$. Thus by completeness of the $\kappa$ reduction at $\vdash_n$, $\Gamma\vdash_n b_i\equiv_\kappa p_j$ and hence $\Gamma\vdash_{n+1} b_i\equiv_\kappa p_j$.
\end{itemize}
\end{proof}

Now we can finally finish the inductive step of the proof of theorem \ref{thm:unique}:

\begin{theorem}[Definitional inversion]\label{thm:1dinv}
$\vdash_{n+1}$ has definitional inversion.
\end{theorem}
\begin{proof}
In each case we apply theorem \ref{thm:ckappa} on the assumptions.
\begin{enumerate}
\item\emph{If $\Gamma\vdash_{n+1} x\equiv y$, then $x=y$, unless $x$ is a proof.}

There are no $\rightsquigarrow_\kappa$ reductions from a variable, so if $\Gamma\vdash_{n+1} x\equiv_\kappa y$ then $\Gamma\vdash_{n+1} x\equiv_p y$. By inversion, either the variable compatibility rule is used, so $x=y$, or $\Gamma\vdash_{n+1} x\equiv_p y$ by proof irrelevance, so that $\Gamma\vdash x,y:p$ for some $\Gamma\vdash p:\P$.

\item \emph{If $\Gamma\vdash_{n+1} \U_\ell\equiv\U_{\ell'}$, then $\ell\equiv\ell'$.}

Again, there are no $\rightsquigarrow_\kappa$ reductions from $\U_\ell$, so $\Gamma\vdash_{n+1} \U_\ell\equiv_p\U_{\ell'}$, and if the compatibility rule is used then $\ell\equiv\ell'$. If proof irrelevance is used, then $\Gamma\vdash_n\U_\ell,\U_{\ell'}:p$ for some $\Gamma\vdash_n p:\P$. Since $\Gamma\vdash_n\U_\ell:\U_{S\ell}:\U_{SS\ell}$ as well, by unique typing at $n$, $\Gamma\vdash_n \P\equiv \U_{SS\ell}$, so by definitional inversion $0\equiv SS\ell$, a contradiction.

\item \emph{If $\Gamma\vdash_{n+1} \forall x:\alpha.\;e\equiv\forall x:\alpha'.\;e'$, then $\Gamma\vdash_{n+1} \alpha\equiv\alpha'$ and $\Gamma,x:\alpha\vdash_{n+1} e\equiv e'$.}

In this case, there are no $\rightsquigarrow_\kappa$ reductions except the compatibility rules, so $\forall x:\alpha.\;e\rightsquigarrow_\kappa^*\forall x:\alpha_1.\;e_1$ for some $\alpha\rightsquigarrow_\kappa^*\alpha_1$ and $e\rightsquigarrow_\kappa^*e_1$, and similarly $\alpha'\rightsquigarrow_\kappa^*\alpha'_1$ and $e'\rightsquigarrow_\kappa^*e'_1$, and if these are $\equiv_p$ equivalent using the compatibility rule then we are done.

If $\Gamma\vdash_{n+1}\forall x:\alpha_1.\;e_1\equiv_p\forall x:\alpha'_1.\;e'_1$ by proof irrelevance, then $\Gamma\vdash_n\forall x:\alpha_1.\;e_1,\forall x:\alpha'_1.\;e'_1:p:\P$. But $\Gamma\vdash_n\forall x:\alpha_1.\;e_1:\U_{\imax(\ell_1,\ell_2)}$ for some $\ell_1,\ell_2$ since $\alpha_1$ and $e_1$ are well-typed, so by unique typing at $n$ $p\equiv\U_{\imax(\ell_1,\ell_2)}$ and $0\equiv S\imax(\ell_1,\ell_2)$, a contradiction.

\item \emph{If $\Gamma\vdash_{n+1} c_{\ell}\equiv c_{\ell'}$, where $c$ is an axiomatic constant, then $\ell\equiv\ell'$, unless $c_\ell$ is a proof.}

Same as the variable case. There are no reductions from an axiomatic constant, so $\Gamma\vdash_{n+1} c_{\ell}\equiv_p c_{\ell'}$; then if the compatibility rule is used we have $\ell\equiv\ell'$, and if proof irrelevance is used then $c_{\ell}$ is a proof.

\item \emph{If $\Gamma\vdash_{n+1} \lambda x:\alpha.\;e\equiv\lambda x:\alpha'.\;e'$, then $\Gamma\vdash_{n+1} \alpha\equiv\alpha'$ and $\Gamma,x:\alpha\vdash_{n+1} e\equiv e'$.}

Since $\Gamma\vdash_n\lambda x:\alpha.\;e:\forall x:\alpha.\;\beta$ and $\Gamma\vdash_n\lambda x:\alpha'.\;e':\forall x:\alpha'.\;\beta'$, by unique typing and definitional inversion at $n$ we have $\Gamma\vdash_n\alpha\equiv\alpha'$.

Thus, $\Gamma,x:\alpha\vdash_{n+1} e\equiv(\lambda x:\alpha.\;e)\;x\equiv(\lambda x:\alpha'.\;e')\;x\equiv e'$ by the beta rule and application rule.
\end{enumerate}
\end{proof}

We've already described the structure of this theorem in earlier parts, but now we are finally ready to put all the parts together:

\begin{proof}[of theorem \ref{thm:unique}]
We prove by induction on $n$ that $\vdash_n$ has definitional inversion (and hence unique typing, by theorem \ref{thm:utype}), and also that it satisfies the conclusion of theorem \ref{thm:ckappa}.
\begin{itemize}
\item For $n=0$, $\vdash_0$ has definitional inversion by lemma \ref{thm:0dinv}, and theorem \ref{thm:ckappa} is trivial (where both $\Gamma\vdash e\equiv_\kappa e'$ and $\Gamma\vdash e\equiv e'$ mean $e=e'$).
\item For $n+1$, suppose $\vdash_n$ has definitional inversion and satisfies theorem \ref{thm:ckappa}. Then all the results of section \ref{sec:church_rosser} follow, including theorem \ref{thm:ckappa}. Then definitional inversion at $n+1$ is theorem \ref{thm:1dinv}.
\end{itemize}
\end{proof}

%\input{Wtypes}